# Contexto e Diretrizes para API Ecode Daycoval

## 1. Vis√£o Geral do Projeto

**Nome:** api-ecode-daycoval  
**Vers√£o:** 2.1.0 (Enhanced with --n-days and --consolidar)  
**Reposit√≥rio:** https://github.com/alvarohtrindade/api-ecode-daycoval.git  
**Descri√ß√£o:** Sistema modular para gera√ß√£o de relat√≥rios automatizados da API Daycoval com suporte a dias √∫teis e consolida√ß√£o de dados.

### 1.1 Principais Funcionalidades

- ‚úÖ **Relat√≥rios automatizados** para endpoints 32, 45, 1048, 1799, 1988
- ‚úÖ **Sistema Enhanced** com retry inteligente e taxa de sucesso >90%
- ‚úÖ **C√°lculo de dias √∫teis** via tabela `DW_CORPORATIVO.Dm_Calendario`
- ‚úÖ **Consolida√ß√£o de dados** em CSV e PDF
- ‚úÖ **CLI modular** com comandos espec√≠ficos por funcionalidade
- ‚úÖ **Testes unit√°rios e integra√ß√£o** completos

### 1.2 Novidades da Vers√£o 2.1

üî• **FEATURE: Suporte a `--n-days`**
- Calcula automaticamente data √∫til D-n consultando tabela `Dm_Calendario`
- Substitui necessidade de especificar datas manualmente
- Funciona com todos os endpoints

üî• **FEATURE: Suporte a `--consolidar`** 
- Agrega dados de m√∫ltiplos fundos em arquivo √∫nico
- Formatos CSV e PDF suportados
- Inclui metadados de origem e timestamps

## 2. Estrutura Arquitet√¥nica

### 2.1 Organiza√ß√£o de M√≥dulos

```
src/daycoval/
‚îú‚îÄ‚îÄ cli/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                          # CLI principal
‚îÇ   ‚îî‚îÄ‚îÄ commands/
‚îÇ       ‚îú‚îÄ‚îÄ enhanced_profitability.py   # üÜï Comandos com --n-days/--consolidar
‚îÇ       ‚îú‚îÄ‚îÄ profitability.py            # Comandos originais
‚îÇ       ‚îú‚îÄ‚îÄ batch_enhanced.py           # Sistema Enhanced
‚îÇ       ‚îú‚îÄ‚îÄ daily.py                    # Relat√≥rios di√°rios
‚îÇ       ‚îî‚îÄ‚îÄ quoteholder.py              # Relat√≥rios de cotistas
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ data_consolidation.py           # üÜï Servi√ßo de consolida√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ profitability_reports.py        # Relat√≥rios de rentabilidade
‚îÇ   ‚îú‚îÄ‚îÄ daily_reports.py               # Relat√≥rios di√°rios
‚îÇ   ‚îî‚îÄ‚îÄ enhanced_batch_processor.py     # Processamento aprimorado
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ date_business.py                # üÜï C√°lculo de dias √∫teis
‚îÇ   ‚îú‚îÄ‚îÄ logging_utils.py               # Sistema de logs
‚îÇ   ‚îî‚îÄ‚îÄ mysql_connector_utils.py        # Conex√£o MySQL
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ models.py                       # Modelos Pydantic
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py                   # Exce√ß√µes customizadas
‚îÇ   ‚îî‚îÄ‚îÄ client.py                       # Cliente da API
‚îî‚îÄ‚îÄ config/
    ‚îú‚îÄ‚îÄ settings.py                     # Configura√ß√µes
    ‚îî‚îÄ‚îÄ portfolios.py                   # Gest√£o de portfolios
```

### 2.2 Endpoints Suportados

| Endpoint | Descri√ß√£o | Comando CLI | Suporte n-days | Consolida√ß√£o |
|----------|-----------|-------------|----------------|--------------|
| **32** | Carteira Di√°ria | `daycoval ecode carteira` | ‚úÖ | ‚úÖ |
| **45** | Posi√ß√£o de Cotistas | `daycoval quoteholder` | ‚ùå | ‚ùå |
| **1048** | Rentabilidade Sint√©tica | `daycoval ecode rentabilidade-sintetica` | ‚úÖ | ‚úÖ |
| **1799** | Relat√≥rio de Rentabilidade | `daycoval profitability relatorio-rentabilidade` | ‚ùå | ‚ùå |
| **1988** | Extrato Conta Corrente | `daycoval profitability extrato-conta-corrente` | ‚ùå | ‚ùå |

## 3. Novos Comandos CLI Implementados

### 3.1 Comando: `daycoval ecode rentabilidade-sintetica`

**Sintaxe completa:**
```bash
daycoval ecode rentabilidade-sintetica \
  [--carteiraId ID] \
  --format {PDF,CSVBR,CSVUS,TXTBR,TXTUS} \
  [--baseDiaria] \
  [--dataInicial YYYY-MM-DD] \
  [--dataFinal YYYY-MM-DD] \
  [--n-days N] \
  [--consolidar] \
  [--formato-consolidado {csv,pdf}] \
  [--saida PATH] \
  [op√ß√µes adicionais...]
```

**Exemplos pr√°ticos:**
```bash
# 1. Portfolio espec√≠fico D-1 (ontem √∫til)
daycoval ecode rentabilidade-sintetica \
  --carteiraId 1001 \
  --format PDF \
  --n-days 1

# 2. Todas as carteiras D-2 com consolida√ß√£o
daycoval ecode rentabilidade-sintetica \
  --format CSVBR \
  --n-days 2 \
  --consolidar \
  --formato-consolidado csv \
  --saida ./reports

# 3. Base di√°ria com per√≠odo espec√≠fico
daycoval ecode rentabilidade-sintetica \
  --carteiraId 1001 \
  --format PDF \
  --baseDiaria \
  --dataInicial 2025-08-01 \
  --dataFinal 2025-08-29
```

### 3.2 Comando: `daycoval ecode carteira`

**Sintaxe completa:**
```bash
daycoval ecode carteira \
  [--portfolio ID] \
  [--data YYYY-MM-DD] \
  [--n-days N] \
  [--consolidar] \
  [--formato {csv,pdf}] \
  [--saida PATH]
```

**Exemplos pr√°ticos:**
```bash
# 1. Portfolio espec√≠fico D-1
daycoval ecode carteira \
  --portfolio 12345 \
  --n-days 1 \
  --formato csv

# 2. Todos os portfolios com consolida√ß√£o
daycoval ecode carteira \
  --n-days 0 \
  --consolidar \
  --formato csv \
  --saida ./reports

# 3. Data espec√≠fica
daycoval ecode carteira \
  --portfolio 12345 \
  --data 2025-09-04 \
  --formato pdf
```

### 3.3 Comando de Teste: `daycoval ecode test-n-days`

```bash
# Testar c√°lculo de dias √∫teis
daycoval ecode test-n-days --n-days 2
```

## 4. Sistema de Dias √öteis

### 4.1 Implementa√ß√£o (`date_business.py`)

**Classe principal:** `BusinessDateCalculator`

```python
from daycoval.utils.date_business import get_business_date_calculator

calculator = get_business_date_calculator()

# D-n dias √∫teis atr√°s
business_date = calculator.get_business_day(n_days=2)

# Data espec√≠fica para dia √∫til anterior
business_date = calculator.get_business_day(specific_date='2025-01-01')

# Verificar se √© dia √∫til
is_business = calculator.is_business_day('2025-09-04')
```

**Funcionalidades:**
- ‚úÖ Consulta tabela `DW_CORPORATIVO.Dm_Calendario`
- ‚úÖ Cache autom√°tico com TTL de 24h
- ‚úÖ Suporte a m√∫ltiplos formatos de data
- ‚úÖ Tratamento robusto de erros
- ‚úÖ Thread safety

### 4.2 Integra√ß√£o com CLI

O sistema `--n-days` resolve automaticamente:

```bash
--n-days 0  # Hoje (ou √∫ltimo dia √∫til)
--n-days 1  # Ontem √∫til (D-1)
--n-days 2  # Anteontem √∫til (D-2)
```

Para `--baseDiaria`:
- `--n-days 1` ‚Üí `dataInicial=D-2, dataFinal=D-1`
- `--n-days 2` ‚Üí `dataInicial=D-3, dataFinal=D-2`

## 5. Sistema de Consolida√ß√£o

### 5.1 Implementa√ß√£o (`data_consolidation.py`)

**Classe principal:** `DataConsolidationService`

```python
from daycoval.services.data_consolidation import create_consolidation_service

service = create_consolidation_service()

# Consolidar CSVs
success = service.consolidate_csv_reports(
    reports, output_path, endpoint_type="1048", include_metadata=True
)

# Consolidar PDFs (implementa√ß√£o b√°sica)
success = service.consolidate_pdf_reports(
    reports, output_path, title="Relat√≥rio Consolidado"
)
```

**Funcionalidades:**
- ‚úÖ Consolida√ß√£o CSV com deduplica√ß√£o
- ‚úÖ Inclus√£o autom√°tica de metadados (FUNDO_ORIGEM, TIMESTAMP)
- ‚úÖ Padroniza√ß√£o de campos (datas, n√∫meros)
- ‚úÖ Valida√ß√£o de schema por endpoint
- ‚úÖ Relat√≥rio de consolida√ß√£o autom√°tico
- üîÑ Consolida√ß√£o PDF (implementa√ß√£o b√°sica)

### 5.2 Metadados Inclu√≠dos

Quando `include_metadata=True`:
```csv
FUNDO_ORIGEM,RELATORIO_INDEX,TIMESTAMP_CONSOLIDACAO,FUNDO,DATA,VALOR
FUNDO_A_FIDC,0,2025-09-04 14:30:25,FUNDO_A_FIDC,2025-09-04,1000.50
FUNDO_B_FIDC,1,2025-09-04 14:30:25,FUNDO_B_FIDC,2025-09-04,2000.75
```

## 6. Testes Implementados

### 6.1 Estrutura de Testes

```
tests/
‚îú‚îÄ‚îÄ test_date_business.py              # Testes unit√°rios dias √∫teis
‚îú‚îÄ‚îÄ test_enhanced_profitability_cli.py # Testes comandos CLI
‚îú‚îÄ‚îÄ test_integration_e2e.py           # Testes integra√ß√£o E2E
‚îú‚îÄ‚îÄ conftest.py                       # Configura√ß√µes pytest
‚îî‚îÄ‚îÄ fixtures/                         # Dados de teste
```

### 6.2 Executar Testes

```bash
# Todos os testes
pytest tests/ -v

# Testes unit√°rios espec√≠ficos
pytest tests/test_date_business.py -v
pytest tests/test_enhanced_profitability_cli.py -v

# Testes de integra√ß√£o (requer DB)
pytest tests/test_integration_e2e.py -m integration

# Cobertura
pytest tests/ --cov=src/daycoval --cov-report=html
```

### 6.3 Markers Dispon√≠veis

- `@pytest.mark.integration` - Requer conex√£o com banco
- `@pytest.mark.slow` - Testes lentos (>5s)
- `@pytest.mark.unit` - Testes unit√°rios r√°pidos

## 7. Configura√ß√£o e Deployment

### 7.1 Vari√°veis de Ambiente

**Obrigat√≥rias:**
```bash
# Banco de dados
DB_HOST=aurora-cluster.cluster-xxx.us-east-1.rds.amazonaws.com
DB_USER=user
DB_PASSWORD=password
DB_NAME=DW_CORPORATIVO

# API Daycoval
APIKEY_GESTOR=your_api_key
PROD_URL=https://apigw.daycoval.com.br/custodia
```

**Opcionais:**
```bash
# Configura√ß√µes avan√ßadas
API_TIMEOUT=120
LOG_LEVEL=INFO
RATE_LIMIT_CALLS=20
RATE_LIMIT_PERIOD=60
```

### 7.2 Instala√ß√£o

```bash
# 1. Instalar depend√™ncias
pip install -r requirements.txt

# 2. Instalar em modo desenvolvimento
pip install -e .

# 3. Verificar instala√ß√£o
daycoval --help
daycoval info
daycoval check-config

# 4. Testar conex√µes
daycoval db-test
```

### 7.3 Estrutura de Diret√≥rios

```bash
# Criar estrutura padr√£o
mkdir -p {data/{input,output,mapping,checkpoints},logs,reports}

# Arquivos de configura√ß√£o
cp .env.template .env  # Editar com credenciais
```

## 8. Troubleshooting

### 8.1 Problemas Comuns

**Erro: "Nenhum dia √∫til encontrado"**
```bash
# Verificar conex√£o com banco
daycoval db-test

# Testar calculadora
daycoval ecode test-n-days --n-days 1
```

**Erro: "Portfolio n√£o encontrado"**
```bash
# Listar portfolios dispon√≠veis
daycoval list-portfolios --limit 20

# Atualizar cache
daycoval db-refresh
```

**Erro: "API timeout"**
```bash
# Usar sistema Enhanced com retry
daycoval batch-enhanced synthetic-enhanced --all-portfolios
```

### 8.2 Logs e Debug

**Localiza√ß√£o dos logs:**
```bash
# Logs da aplica√ß√£o
tail -f logs/daycoval.log

# Logs espec√≠ficos
tail -f logs/date_business_test.log
tail -f logs/consolidation.log
```

**Debug verbose:**
```bash
# Executar com verbose
daycoval --verbose ecode rentabilidade-sintetica --carteiraId 1001 --format PDF
```

### 8.3 Performance

**Sistema Enhanced (recomendado para produ√ß√£o):**
```bash
# Taxa de sucesso >90%
daycoval batch-enhanced synthetic-enhanced \
  --all-portfolios \
  --format CSVBR \
  --rate-limit-delay 2.0
```

**Configurar rate limiting:**
```python
# Em .env
RATE_LIMIT_CALLS=15  # Reduzir para APIs inst√°veis
RATE_LIMIT_PERIOD=60
```

## 9. Roadmap e Melhorias Futuras

### 9.1 Funcionalidades Planejadas

- üîÑ **Consolida√ß√£o PDF** completa com PyPDF2/reportlab
- üîÑ **Suporte a `--n-days`** para endpoints 1799 e 1988
- üîÑ **Cache de relat√≥rios** com Redis
- üîÑ **Notifica√ß√µes** via email/Slack
- üîÑ **Dashboard web** para monitoramento
- üîÑ **Agendamento** com cron jobs

### 9.2 Melhorias T√©cnicas

- üîÑ **Paraleliza√ß√£o** de requests com asyncio
- üîÑ **Compress√£o** de arquivos grandes
- üîÑ **Valida√ß√£o avan√ßada** de dados com Great Expectations
- üîÑ **M√©tricas** com Prometheus/Grafana
- üîÑ **CI/CD** com GitHub Actions

### 9.3 Compatibilidade

**Vers√µes Python suportadas:** 3.8+  
**Depend√™ncias principais:**
- `click>=8.0.0` - CLI framework
- `mysql-connector-python>=8.0.0` - MySQL driver
- `pydantic>=1.8.0` - Valida√ß√£o de dados
- `requests>=2.25.0` - HTTP client
- `python-dotenv>=0.19.0` - Vari√°veis de ambiente

## 10. Changelog

### Vers√£o 2.1.0 (2025-09-04)

**üÜï Novas funcionalidades:**
- ‚úÖ Argumento `--n-days` para c√°lculo autom√°tico de dias √∫teis
- ‚úÖ Argumento `--consolidar` para agrega√ß√£o de dados
- ‚úÖ Sistema completo de dias √∫teis via tabela `Dm_Calendario`
- ‚úÖ Servi√ßo de consolida√ß√£o CSV/PDF
- ‚úÖ Comandos CLI aprimorados (`daycoval ecode`)
- ‚úÖ Testes unit√°rios e integra√ß√£o completos

**üîß Melhorias:**
- ‚úÖ C√≥digo defensivo com tratamento de erros
- ‚úÖ Logging estruturado e detalhado
- ‚úÖ Valida√ß√£o de par√¢metros aprimorada
- ‚úÖ Documenta√ß√£o completa e exemplos

**üêõ Corre√ß√µes:**
- ‚úÖ Parsing CLI mais robusto
- ‚úÖ Tratamento de encoding em CSVs
- ‚úÖ Gest√£o de mem√≥ria para arquivos grandes

### Vers√£o 2.0.0 (Base)
- ‚úÖ Estrutura modular completa
- ‚úÖ Suporte a todos os endpoints
- ‚úÖ Sistema Enhanced com retry
- ‚úÖ CLI organizado com subcomandos

## 11. Contatos e Suporte

**Desenvolvedor:** Claude Code  
**Email:** alvaro.htrindade@gmail.com  
**Reposit√≥rio:** https://github.com/alvarohtrindade/api-ecode-daycoval  

**Para suporte:**
1. Consultar este documento (CLAUDE.md)
2. Executar `daycoval check-config` para diagn√≥stico
3. Verificar logs em `logs/`
4. Abrir issue no GitHub com logs e contexto