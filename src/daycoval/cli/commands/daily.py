"""
Comandos CLI para relat√≥rios di√°rios.
"""
import os
import asyncio
from datetime import datetime
from pathlib import Path

import click

from ...config.portfolios import get_portfolio_manager
from ...services.daily_reports import create_daily_report_service
from ...core.models import ReportFormat, DailyReportRequest, ReportType
from ...core.exceptions import DaycovalError


@click.group()
def daily_cli():
    """Comandos para relat√≥rios de carteira di√°ria."""
    pass


@daily_cli.command('single')
@click.argument('portfolio_id')
@click.argument('date', type=click.DateTime(['%Y-%m-%d']))
@click.option('--format', 'report_format', default='PDF',
              type=click.Choice(['PDF', 'CSVBR', 'CSVUS', 'TXTBR', 'TXTUS', 'JSON']))
@click.option('--output-dir', default='./reports', help='Diret√≥rio de sa√≠da')
@click.option('--async-mode', is_flag=True, help='Usar modo ass√≠ncrono')
@click.pass_context
def single(ctx, portfolio_id: str, date: datetime, report_format: str, 
           output_dir: str, async_mode: bool):
    """Gera relat√≥rio para um √∫nico portfolio."""
    verbose = ctx.obj.get('verbose', False)
    
    try:
        # Obter portfolio
        portfolio_manager = get_portfolio_manager()
        portfolio = portfolio_manager.get_portfolio(portfolio_id)
        
        click.echo(f"üìä Gerando relat√≥rio di√°rio para:")
        click.echo(f"   Portfolio: {portfolio.id} ({portfolio.name})")
        click.echo(f"   Data: {date.strftime('%Y-%m-%d')}")
        click.echo(f"   Formato: {report_format}")
        
        # Configurar servi√ßo
        service = create_daily_report_service()
        
        # Criar requisi√ß√£o
        request = DailyReportRequest(
            portfolio=portfolio,
            date=date,
            format=ReportFormat(report_format),
            report_type=ReportType.DAILY
        )
        
        # Obter relat√≥rio
        if async_mode:
            report = asyncio.run(service.get_report(request))
        else:
            report = service.get_report_sync(request)
        
        # Salvar arquivo
        output_path = Path(output_dir)
        success = service.save_report(report, output_path)
        
        if success:
            click.echo(f"‚úÖ Relat√≥rio salvo: {output_path / report.filename}")
            click.echo(f"üìä Tamanho: {report.size_mb:.2f} MB")
        else:
            click.echo("‚ùå Erro ao salvar relat√≥rio", err=True)
            return False
            
        return True
        
    except DaycovalError as e:
        click.echo(f"‚ùå Erro Daycoval: {e}", err=True)
        return False
    except Exception as e:
        click.echo(f"‚ùå Erro inesperado: {e}", err=True)
        if verbose:
            import traceback
            traceback.print_exc()
        return False


@daily_cli.command('batch')
@click.argument('date', type=click.DateTime(['%Y-%m-%d']))
@click.option('--format', 'report_format', default='PDF',
              type=click.Choice(['PDF', 'CSVBR', 'CSVUS', 'TXTBR', 'TXTUS', 'JSON']))
@click.option('--output-dir', default='./reports', help='Diret√≥rio de sa√≠da')
@click.option('--portfolios', help='IDs espec√≠ficos (separados por v√≠rgula)')
@click.option('--all-portfolios', is_flag=True, help='Todos os portfolios')
@click.option('--async-mode', is_flag=True, help='Usar modo ass√≠ncrono')
@click.option('--max-concurrent', default=5, help='M√°ximo de requisi√ß√µes simult√¢neas')
@click.pass_context
def batch(ctx, date: datetime, report_format: str, output_dir: str,
          portfolios: str, all_portfolios: bool, async_mode: bool, max_concurrent: int):
    """Gera relat√≥rios em lote."""
    verbose = ctx.obj.get('verbose', False)
    
    try:
        # Determinar portfolios
        portfolio_manager = get_portfolio_manager()
        
        if all_portfolios:
            portfolio_dict = portfolio_manager.get_all_portfolios()
            portfolio_list = list(portfolio_dict.values())
            click.echo(f"üìä Processando TODOS os {len(portfolio_list)} portfolios")
        elif portfolios:
            portfolio_ids = [p.strip() for p in portfolios.split(',')]
            portfolio_list = []
            for pid in portfolio_ids:
                portfolio_list.append(portfolio_manager.get_portfolio(pid))
            click.echo(f"üìä Processando {len(portfolio_list)} portfolios espec√≠ficos")
        else:
            click.echo("‚ùå Especifique --all-portfolios ou --portfolios", err=True)
            return False
        
        click.echo(f"   Data: {date.strftime('%Y-%m-%d')}")
        click.echo(f"   Formato: {report_format}")
        click.echo(f"   Modo: {'Ass√≠ncrono' if async_mode else 'S√≠ncrono'}")
        
        # Configurar servi√ßo
        service = create_daily_report_service()
        
        # Processar relat√≥rios
        if async_mode:
            reports = asyncio.run(_process_batch_async(
                service, portfolio_list, date, report_format, max_concurrent
            ))
        else:
            reports = _process_batch_sync(
                service, portfolio_list, date, report_format
            )
        
        # Salvar relat√≥rios
        output_path = Path(output_dir)
        successful, failed = service.save_multiple_reports(reports, output_path)
        
        # Estat√≠sticas finais
        total = len(portfolio_list)
        success_rate = (successful / total * 100) if total > 0 else 0
        
        click.echo(f"\nüéØ RESULTADO FINAL:")
        click.echo(f"   Total: {total}")
        click.echo(f"   ‚úÖ Sucessos: {successful}")
        click.echo(f"   ‚ùå Falhas: {failed}")
        click.echo(f"   üìà Taxa de sucesso: {success_rate:.1f}%")
        
        return successful > 0
        
    except DaycovalError as e:
        click.echo(f"‚ùå Erro Daycoval: {e}", err=True)
        return False
    except Exception as e:
        click.echo(f"‚ùå Erro inesperado: {e}", err=True)
        if verbose:
            import traceback
            traceback.print_exc()
        return False


@daily_cli.command('validate')
@click.argument('portfolio_id')
@click.argument('date', type=click.DateTime(['%Y-%m-%d']))
def validate(portfolio_id: str, date: datetime):
    """Valida se um portfolio pode gerar relat√≥rio para uma data."""
    try:
        # Verificar portfolio
        portfolio_manager = get_portfolio_manager()
        portfolio = portfolio_manager.get_portfolio(portfolio_id)
        
        click.echo(f"üîç Validando:")
        click.echo(f"   Portfolio: {portfolio.id} ({portfolio.name})")
        click.echo(f"   Data: {date.strftime('%Y-%m-%d')}")
        
        # Valida√ß√µes b√°sicas
        if date > datetime.now():
            click.echo("‚ùå Data √© futura")
            return False
        
        # Testar conectividade (sem fazer request real)
        from ...core.client import APIClient
        from ...config.settings import get_settings
        
        settings = get_settings()
        client = APIClient(settings.api)
        
        click.echo("‚úÖ Portfolio v√°lido")
        click.echo("‚úÖ Data v√°lida")
        click.echo("‚úÖ Configura√ß√£o OK")
        
        return True
        
    except Exception as e:
        click.echo(f"‚ùå Valida√ß√£o falhou: {e}", err=True)
        return False


@daily_cli.command('retry-failed')
@click.argument('date', type=click.DateTime(['%Y-%m-%d']))
@click.option('--format', 'report_format', default='PDF',
              type=click.Choice(['PDF', 'CSVBR', 'CSVUS', 'TXTBR', 'TXTUS', 'JSON']))
@click.option('--output-dir', default='./reports', help='Diret√≥rio de sa√≠da')
@click.option('--failed-portfolios', help='IDs que falharam (separados por v√≠rgula)')
@click.option('--timeout', default=120, help='Timeout em segundos para retry')
@click.pass_context
def retry_failed(ctx, date: datetime, report_format: str, output_dir: str,
                failed_portfolios: str, timeout: int):
    """Retenta portfolios que falharam com timeout maior."""
    verbose = ctx.obj.get('verbose', False)
    
    if not failed_portfolios:
        # Portfolios conhecidos por serem problem√°ticos
        problem_portfolios = [
            "8205906",   # Timeout frequente
            "10627715",  # Erro 500
            "18205906",  # Erro 500 
            "20784047"   # Erro 500
        ]
        click.echo(f"üîÑ Testando portfolios problem√°ticos conhecidos:")
        for pid in problem_portfolios:
            click.echo(f"   {pid}")
    else:
        problem_portfolios = [p.strip() for p in failed_portfolios.split(',')]
        click.echo(f"üîÑ Retentando {len(problem_portfolios)} portfolios espec√≠ficos")
    
    try:
        # Configurar timeout maior
        os.environ['API_TIMEOUT'] = str(timeout)
        
        portfolio_manager = get_portfolio_manager()
        portfolio_list = []
        
        for pid in problem_portfolios:
            try:
                portfolio = portfolio_manager.get_portfolio(pid)
                portfolio_list.append(portfolio)
            except Exception as e:
                click.echo(f"‚ùå Portfolio {pid} n√£o encontrado: {e}")
        
        if not portfolio_list:
            click.echo("‚ùå Nenhum portfolio v√°lido para testar")
            return False
        
        click.echo(f"‚è∞ Timeout configurado: {timeout}s")
        
        # Processar com timeout maior
        service = create_daily_report_service()
        reports = _process_batch_sync(service, portfolio_list, date, report_format)
        
        # Salvar resultados
        output_path = Path(output_dir)
        successful, failed = service.save_multiple_reports(reports, output_path)
        
        click.echo(f"\nüéØ RESULTADO RETRY:")
        click.echo(f"   ‚úÖ Sucessos: {successful}")
        click.echo(f"   ‚ùå Falhas: {failed}")
        
        return successful > 0
        
    except Exception as e:
        click.echo(f"‚ùå Erro no retry: {e}", err=True)
        return False


async def _process_batch_async(service, portfolios, date, report_format, max_concurrent):
    """Processa lote de forma ass√≠ncrona."""
    import asyncio
    from ...core.models import ReportFormat, ReportType
    
    semaphore = asyncio.Semaphore(max_concurrent)
    
    async def process_single(portfolio):
        async with semaphore:
            try:
                request = DailyReportRequest(
                    portfolio=portfolio,
                    date=date,
                    format=ReportFormat(report_format),
                    report_type=ReportType.DAILY
                )
                return await service.get_report(request)
            except Exception as e:
                click.echo(f"‚ùå Erro no portfolio {portfolio.id}: {e}")
                return None
    
    # Executar todas as tarefas
    tasks = [process_single(p) for p in portfolios]
    results = await asyncio.gather(*tasks)
    
    # Filtrar apenas sucessos
    return [r for r in results if r is not None]


def _process_batch_sync(service, portfolios, date, report_format):
    """Processa lote de forma s√≠ncrona."""
    from ...core.models import ReportFormat, ReportType
    from ...core.exceptions import ReportProcessingError, EmptyReportError, TimeoutError
    
    reports = []
    processing_errors = []
    timeout_errors = []
    empty_errors = []
    
    for i, portfolio in enumerate(portfolios, 1):
        try:
            click.echo(f"üîÑ Processando {i}/{len(portfolios)}: {portfolio.id}")
            
            request = DailyReportRequest(
                portfolio=portfolio,
                date=date,
                format=ReportFormat(report_format),
                report_type=ReportType.DAILY
            )
            
            report = service.get_report_sync(request)
            reports.append(report)
            
        except ReportProcessingError as e:
            processing_errors.append((portfolio.id, str(e)))
            click.echo(f"‚è≥ Portfolio {portfolio.id}: Relat√≥rio em processamento")
            
        except EmptyReportError as e:
            empty_errors.append((portfolio.id, str(e)))
            click.echo(f"üìÑ Portfolio {portfolio.id}: Relat√≥rio vazio")
            
        except TimeoutError as e:
            timeout_errors.append((portfolio.id, str(e)))
            click.echo(f"‚è∞ Portfolio {portfolio.id}: Timeout")
            
        except Exception as e:
            click.echo(f"‚ùå Erro no portfolio {portfolio.id}: {e}")
    
    # Mostrar estat√≠sticas detalhadas
    if processing_errors:
        click.echo(f"\n‚è≥ {len(processing_errors)} portfolios em processamento:")
        for pid, _ in processing_errors[:5]:  # Mostrar primeiros 5
            click.echo(f"   {pid}")
        if len(processing_errors) > 5:
            click.echo(f"   ... e mais {len(processing_errors) - 5}")
    
    if timeout_errors:
        click.echo(f"\n‚è∞ {len(timeout_errors)} portfolios com timeout:")
        for pid, _ in timeout_errors[:5]:
            click.echo(f"   {pid}")
        if len(timeout_errors) > 5:
            click.echo(f"   ... e mais {len(timeout_errors) - 5}")
    
    if empty_errors:
        click.echo(f"\nüìÑ {len(empty_errors)} portfolios com relat√≥rios vazios:")
        for pid, _ in empty_errors[:5]:
            click.echo(f"   {pid}")
        if len(empty_errors) > 5:
            click.echo(f"   ... e mais {len(empty_errors) - 5}")
    
    return reports