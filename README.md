# Sistema Unificado de Relat√≥rios Daycoval

Sistema completo para gera√ß√£o automatizada de relat√≥rios da API Daycoval, com suporte a m√∫ltiplos endpoints e processamento em lote.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Instala√ß√£o e Configura√ß√£o](#instala√ß√£o-e-configura√ß√£o)
- [Relat√≥rios Dispon√≠veis](#relat√≥rios-dispon√≠veis)
- [Guia de Uso](#guia-de-uso)
- [Par√¢metros Avan√ßados](#par√¢metros-avan√ßados)
- [Exemplos Pr√°ticos](#exemplos-pr√°ticos)
- [Solu√ß√£o de Problemas](#solu√ß√£o-de-problemas)

## üéØ Vis√£o Geral

Este sistema permite gerar cinco tipos principais de relat√≥rios da API Daycoval:

| Endpoint | Tipo de Relat√≥rio | Descri√ß√£o |
|----------|-------------------|-----------|
| **32** | **Carteira Di√°ria** | Relat√≥rios de posi√ß√£o da carteira em uma data espec√≠fica |
| **45** | **Posi√ß√£o de Cotistas** | Relat√≥rios detalhados dos cotistas por fundo |
| **1048** | **Rentabilidade Sint√©tica** | Relat√≥rios de rentabilidade sint√©tica com base di√°ria opcional |
| **1799** | **Relat√≥rio de Rentabilidade** | Relat√≥rios de rentabilidade com √≠ndice CDI configur√°vel |
| **1988** | **Extrato Conta Corrente** | Extratos de conta corrente por per√≠odo e ag√™ncia/conta |

### ‚ú® Principais Funcionalidades

- ‚úÖ **Processamento Individual ou em Lote** (1 fundo ou todos os 104 fundos)
- ‚úÖ **Rate Limiting Autom√°tico** (evita sobrecarga na API)
- ‚úÖ **Retry Inteligente Aprimorado** (sistema avan√ßado de recupera√ß√£o de falhas)
- ‚úÖ **Persist√™ncia de Falhas** (checkpoint system para reprocessamento)
- ‚úÖ **Taxa de Sucesso 90%+** (sistema enhanced batch com circuit breaker)
- ‚úÖ **M√∫ltiplos Formatos** (PDF, CSV, TXT, JSON)
- ‚úÖ **Configura√ß√£o Flex√≠vel** (defaults inteligentes + customiza√ß√£o)
- ‚úÖ **Logs Detalhados** (rastreamento completo do processo)

## üöÄ Instala√ß√£o e Configura√ß√£o

### 1. Configura√ß√£o Inicial

```bash
# Execute o script de configura√ß√£o
python setup.py

# Isso ir√°:
# - Verificar depend√™ncias
# - Criar diret√≥rios necess√°rios
# - Validar arquivo de configura√ß√£o
# - Testar conectividade com API
```

### 2. Estrutura de Arquivos

```
daycoval/
‚îú‚îÄ‚îÄ api.py                    # M√≥dulo principal da API
‚îú‚îÄ‚îÄ batch_processor.py        # Processamento em lote
‚îú‚îÄ‚îÄ quoteholder_reports.py    # M√≥dulo para relat√≥rios de cotistas
‚îú‚îÄ‚îÄ cli.py                   # Interface de linha de comando
‚îú‚îÄ‚îÄ portfolios.json          # Configura√ß√£o dos fundos
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ logging_utils.py     # Sistema de logs
‚îî‚îÄ‚îÄ reports/                 # Diret√≥rio de sa√≠da (criado automaticamente)
```

### 3. Arquivo de Configura√ß√£o

O arquivo `portfolios.json` cont√©m:
- **95 fundos mapeados** (ID ‚Üí Nome)
- **Configura√ß√µes padr√£o** para relat√≥rios de cotistas
- **Configura√ß√µes de rate limiting**

## üìä Relat√≥rios Dispon√≠veis

### üè¶ Relat√≥rio de Carteira Di√°ria (Endpoint 32)

**O que cont√©m:**
- Posi√ß√µes dos ativos na carteira
- Valores de mercado
- Rentabilidade
- Composi√ß√£o da carteira

**Quando usar:**
- Relat√≥rios di√°rios de posi√ß√£o
- Acompanhamento de performance
- An√°lise de composi√ß√£o de portf√≥lio

### üë• Relat√≥rio de Posi√ß√£o de Cotistas (Endpoint 45)

**O que cont√©m:**
- Lista detalhada de cotistas
- Quantidade de cotas por investidor
- Informa√ß√µes de assessores
- Classifica√ß√£o por tipo de investidor

**Quando usar:**
- Controle de base de cotistas
- Relat√≥rios regulamentares
- An√°lise de distribui√ß√£o

### üìà Relat√≥rio de Rentabilidade Sint√©tica (Endpoint 1048) ‚≠ê NOVO

**O que cont√©m:**
- An√°lise de rentabilidade sint√©tica com base di√°ria opcional
- Compara√ß√£o com √≠ndices de refer√™ncia configur√°veis
- M√©tricas de performance ajustadas por per√≠odo
- Dados hist√≥ricos personaliz√°veis por data

**Caracter√≠sticas avan√ßadas:**
- ‚úÖ **Portfolio Opcional**: Pode processar TODAS as carteiras quando omitido
- ‚úÖ **Base Di√°ria**: An√°lise por per√≠odo espec√≠fico (dataInicial ‚Üí dataFinal)
- ‚úÖ **M√∫ltiplos Tipos**: Cadastro (0), In√≠cio a In√≠cio (1), Fim a Fim (2)
- ‚úÖ **Sa√≠da Dupla**: Individual por fundo + Consolidado (CSV)

**Quando usar:**
- An√°lise de performance de fundos espec√≠ficos ou portfolio completo
- Compara√ß√£o de rentabilidade em per√≠odos hist√≥ricos
- Relat√≥rios executivos de gest√£o
- Monitoramento de indicadores customiz√°veis

### üí∞ Relat√≥rio de Rentabilidade (Endpoint 1799) ‚≠ê NOVO

**O que cont√©m:**
- An√°lise de rentabilidade com √≠ndice CDI configur√°vel
- Indicadores de performance personaliz√°veis
- Tratamento de movimento de ajuste compartilhado
- Flexibilidade na configura√ß√£o de t√≠tulos e logotipos

**Caracter√≠sticas avan√ßadas:**
- ‚úÖ **√çndice CDI Configur√°vel**: Permite definir diferentes √≠ndices de refer√™ncia
- ‚úÖ **Formata√ß√£o Personaliz√°vel**: Nome longo/curto no t√≠tulo, posi√ß√£o do nome do relat√≥rio
- ‚úÖ **Tratamento de Ajustes**: Op√ß√£o para tratar movimentos de ajuste compartilhado
- ‚úÖ **Data Opcional**: Usa data atual se n√£o especificada

**Quando usar:**
- Relat√≥rios de rentabilidade com refer√™ncia CDI espec√≠fica
- An√°lise personalizada de performance
- Compara√ß√µes com √≠ndices de mercado customizados

### üè¶ Extrato Conta Corrente (Endpoint 1988) ‚≠ê NOVO

**O que cont√©m:**
- Extratos banc√°rios detalhados por per√≠odo
- Movimenta√ß√µes de conta corrente espec√≠fica
- Filtros por ag√™ncia e conta
- Controle de per√≠odo com dias configur√°veis

**Caracter√≠sticas avan√ßadas:**
- ‚úÖ **Filtro por Ag√™ncia/Conta**: Busca espec√≠fica por dados banc√°rios
- ‚úÖ **Per√≠odo Flex√≠vel**: Data inicial obrigat√≥ria, final opcional
- ‚úÖ **Controle de Dias**: Par√¢metro adicional para controle temporal
- ‚úÖ **M√∫ltiplos Formatos**: PDF, CSV, TXT com formata√ß√£o BR/US

**Quando usar:**
- Concilia√ß√£o banc√°ria detalhada
- Auditoria de movimenta√ß√µes por conta
- Relat√≥rios de compliance banc√°rio
- An√°lise de fluxo de caixa por ag√™ncia

## üìñ Guia de Uso

### Sintaxe B√°sica

```bash
python cli.py [op√ß√µes_globais] [tipo_relat√≥rio] [modo] [par√¢metros]
```

**Componentes:**
- **Op√ß√µes globais**: `--format`, `--output-dir`, `--verbose`
- **Tipo de relat√≥rio**: `daily`, `quoteholder` ou `profitability`
- **Modo**: `single` (1 fundo) ou `batch` (m√∫ltiplos fundos)
- **Par√¢metros**: Espec√≠ficos de cada tipo de relat√≥rio

### üè¶ Relat√≥rios de Carteira Di√°ria

#### Um Fundo Espec√≠fico
```bash
# Formato PDF (padr√£o)
python cli.py daily single --portfolio 4471709 --date 2025-07-31

# Formato CSV Brasileiro
python cli.py --format CSVBR daily single --portfolio 4471709 --date 2025-07-31

# Com preview das primeiras linhas (apenas texto)
python cli.py daily single --portfolio 4471709 --date 2025-07-31 --preview
```

#### Todos os Fundos (Lote)
```bash
# Todos os 95 fundos em PDF
python cli.py daily batch --all-portfolios --date 2025-07-31

# Fundos espec√≠ficos
python cli.py daily batch --portfolio-list "4471709,8205906,8310432" --date 2025-07-31

# Com diret√≥rio personalizado
python cli.py --output-dir ./relatorios_diarios daily batch --all-portfolios --date 2025-07-31
```

### üë• Relat√≥rios de Posi√ß√£o de Cotistas

#### Um Fundo Espec√≠fico
```bash
# Configura√ß√£o b√°sica (usa defaults)
python cli.py quoteholder single --portfolio 4471709 --date 2025-07-31

# Com range espec√≠fico de clientes
python cli.py quoteholder single --portfolio 4471709 --date 2025-07-31 --client-range "1000:5000"

# Para classe espec√≠fica de investidor (0 = Pessoa Jur√≠dica)
python cli.py quoteholder single --portfolio 4471709 --date 2025-07-31 --investor-class 0

# Com headers Excel habilitados
python cli.py quoteholder single --portfolio 4471709 --date 2025-07-31 --excel-headers true
```

#### Todos os Fundos (Lote)
```bash
# Todos os fundos com configura√ß√£o padr√£o
python cli.py quoteholder batch --all-portfolios --date 2025-07-31

# Todos os fundos, apenas Pessoa F√≠sica (classe 2)
python cli.py quoteholder batch --all-portfolios --date 2025-07-31 --investor-class 2

# Fundos espec√≠ficos com par√¢metros customizados
python cli.py quoteholder batch --portfolio-list "4471709,8205906" --date 2025-07-31 \
    --client-range "1:999999" \
    --investor-class -1 \
    --excel-headers true
```

### üìà Relat√≥rios de Rentabilidade Sint√©tica (CORRIGIDO v2.1)

**üîß CORRE√á√ïES IMPLEMENTADAS:**
- ‚úÖ Corre√ß√£o do parser CLI: `--daily-base` n√£o √© mais interpretado como portfolio ID
- ‚úÖ Implementa√ß√£o de relat√≥rios individuais + consolidado para `--all-portfolios`
- ‚úÖ Par√¢metros de data agora funcionam corretamente com `--daily-base`

#### Comando Synthetic Otimizado (RECOMENDADO)
```bash
# Portfolio espec√≠fico com base di√°ria (COMANDO CORRIGIDO)
daycoval profitability synthetic \
    --portfolio-id 1001 \
    --daily-base \
    --start-date 2025-08-01 \
    --end-date 2025-08-29 \
    --format PDF \
    --profitability-type 0

# TODOS os portfolios - gera 104 arquivos individuais + 1 consolidado
daycoval profitability synthetic \
    --all-portfolios \
    --format CSVBR \
    --daily-base \
    --start-date 2025-08-01 \
    --end-date 2025-08-29 \
    --output-dir ./reports

# üöÄ PROCESSAMENTO APRIMORADO com retry inteligente (RECOMENDADO)
daycoval batch-enhanced synthetic-enhanced \
    --all-portfolios \
    --format CSVBR \
    --rate-limit-delay 2.0 \
    --output-dir ./reports

# Portfolio espec√≠fico sem base di√°ria
daycoval profitability synthetic \
    --portfolio-id 2050 \
    --format PDF \
    --profitability-type 1
```

#### Comando Direto (Endpoint 1048)
```bash
# Relat√≥rio para carteira espec√≠fica em PDF
daycoval profitability relatorio-rentabilidade-sintetica --carteiraId 111376 --format PDF

# Relat√≥rio para TODAS as carteiras (carteiraId omitido) em CSV
daycoval profitability relatorio-rentabilidade-sintetica --format CSVBR

# Com base di√°ria e per√≠odo espec√≠fico
daycoval profitability relatorio-rentabilidade-sintetica \
    --carteiraId 111376 \
    --format PDF \
    --baseDiaria \
    --dataInicial 2022-10-03 \
    --dataFinal 2022-10-07 \
    --tipoRentabilidadeIndice 0
```

#### Comando Simplificado
```bash
# Usando comando 'synthetic' (mais amig√°vel)
daycoval profitability synthetic 111376 --format PDF --daily-base \
    --start-date 2022-10-03 --end-date 2022-10-07

# Todas as carteiras
daycoval profitability synthetic --all-portfolios --format CSVBR
```

### üí∞ Relat√≥rios de Rentabilidade (Endpoint 1799) ‚≠ê NOVO

#### Comando Direto
```bash
# Relat√≥rio de rentabilidade b√°sico em PDF
daycoval profitability relatorio-rentabilidade \
    --carteira 111376 \
    --format PDF \
    --indiceCDI CDI

# Relat√≥rio com data espec√≠fica e configura√ß√µes personalizadas
daycoval profitability relatorio-rentabilidade \
    --carteira 111376 \
    --format CSVBR \
    --data 2022-10-07 \
    --indiceCDI CDI \
    --usaNomeLongoTitulo \
    --trataMovimentoAjusteComp
```

#### Par√¢metros Dispon√≠veis (Endpoint 1799)

| Par√¢metro | Tipo | Obrigat√≥rio | Descri√ß√£o | Exemplo |
|-----------|------|-------------|-----------|---------|
| `--carteira` | Integer | ‚úÖ | C√≥digo da carteira | `111376` |
| `--format` | String | ‚úÖ | Formato do relat√≥rio | PDF, CSVBR, CSVUS, TXTBR, TXTUS |
| `--data` | String | ‚ùå | Data de refer√™ncia | 2022-10-07 |
| `--indiceCDI` | String | ‚ùå | √çndice CDI | CDI (default) |
| `--nomeRelatorioEsquerda` | Boolean | ‚ùå | Nome relat√≥rio √† esquerda | Default: true |
| `--omiteLogotipo` | Boolean | ‚ùå | Omitir logotipo | Default: false |
| `--usaNomeCurtoCarteira` | Boolean | ‚ùå | Nome curto da carteira | Default: false |
| `--usaNomeLongoTitulo` | Boolean | ‚ùå | Nome longo no t√≠tulo | Default: false |
| `--trataMovimentoAjusteComp` | Boolean | ‚ùå | Tratar movimento ajuste | Default: true |

### üè¶ Extratos Conta Corrente (Endpoint 1988) ‚≠ê NOVO

#### Comando Direto
```bash
# Extrato conta corrente b√°sico
daycoval profitability extrato-conta-corrente \
    --carteira 17485 \
    --format PDF \
    --dataInicial 2024-05-01 \
    --agencia 00019 \
    --conta 0000000123

# Extrato com per√≠odo definido e formata√ß√£o CSV
daycoval profitability extrato-conta-corrente \
    --carteira 17485 \
    --format CSVBR \
    --dataInicial 2024-05-01 \
    --dataFinal 2024-05-31 \
    --agencia 00019 \
    --conta 0000000123 \
    --dias 30
```

#### Par√¢metros Dispon√≠veis (Endpoint 1988)

| Par√¢metro | Tipo | Obrigat√≥rio | Descri√ß√£o | Exemplo |
|-----------|------|-------------|-----------|---------|
| `--carteira` | Integer | ‚úÖ | C√≥digo da carteira | `17485` |
| `--format` | String | ‚úÖ | Formato do relat√≥rio | PDF, CSVBR, CSVUS, TXTBR, TXTUS |
| `--dataInicial` | String | ‚úÖ | Data inicial | 2024-05-01 |
| `--dataFinal` | String | ‚ùå | Data final | 2024-05-31 |
| `--agencia` | String | ‚úÖ | C√≥digo da ag√™ncia | 00019 |
| `--conta` | String | ‚úÖ | N√∫mero da conta | 0000000123 |
| `--dias` | Integer | ‚ùå | N√∫mero de dias | Default: 0 |
| `--nomeRelatorioEsquerda` | Boolean | ‚ùå | Nome relat√≥rio √† esquerda | Default: true |
| `--omiteLogotipo` | Boolean | ‚ùå | Omitir logotipo | Default: false |
| `--usaNomeCurtoCarteira` | Boolean | ‚ùå | Nome curto da carteira | Default: false |

#### Par√¢metros Dispon√≠veis (Endpoint 1048)

| Par√¢metro | Tipo | Obrigat√≥rio | Descri√ß√£o | Valores |
|-----------|------|-------------|-----------|---------|
| `--carteiraId` | Integer | ‚ùå | C√≥digo da carteira | Se omitido: todas as carteiras |
| `--format` | String | ‚úÖ | Formato do relat√≥rio | PDF, CSVBR, CSVUS, TXTBR, TXTUS |
| `--baseDiaria` | Boolean | ‚ùå | Base di√°ria | Default: false |
| `--dataInicial` | String | Condicional* | Data inicial | YYYY-MM-DD |
| `--dataFinal` | String | Condicional* | Data final | YYYY-MM-DD |
| `--nomeRelatorioEsquerda` | Boolean | ‚ùå | Nome relat√≥rio √† esquerda | Default: true |
| `--omiteLogotipo` | Boolean | ‚ùå | Omitir logotipo | Default: false |
| `--usaNomeCurtoCarteira` | Boolean | ‚ùå | Nome curto da carteira | Default: false |
| `--tipoRentabilidadeIndice` | Integer | ‚ùå | Tipo de rentabilidade | 0, 1 ou 2 (default: 0) |
| `--emitirPosicaoDeD0Abertura` | Boolean | ‚ùå | Emitir posi√ß√£o D0 | Default: false |

*\*Obrigat√≥rio se `--baseDiaria` for true*

## üöÄ Sistema Enhanced - Processamento Aprimorado (NOVO!)

**Taxa de Sucesso: 90%+ (vs 57% do sistema padr√£o)**

O sistema Enhanced √© uma vers√£o aprimorada com retry inteligente e persist√™ncia de falhas, ideal para processamento em lote de grande escala.

### Principais Melhorias

- ‚úÖ **Retry Inteligente**: Sistema avan√ßado com backoff exponencial
- ‚úÖ **Persist√™ncia de Falhas**: Checkpoints autom√°ticos para reprocessamento  
- ‚úÖ **Circuit Breaker**: Isolamento de portfolios problem√°ticos
- ‚úÖ **Rate Limiting Adaptativo**: Otimiza√ß√£o autom√°tica de performance
- ‚úÖ **Monitoramento Detalhado**: Estat√≠sticas em tempo real
- ‚úÖ **Recupera√ß√£o Autom√°tica**: Reprocessamento de falhas sem interven√ß√£o manual

### Comandos Enhanced

#### 1. Processamento Aprimorado
```bash
# Processar TODOS os portfolios com retry inteligente
daycoval batch-enhanced synthetic-enhanced \
    --all-portfolios \
    --format CSVBR \
    --rate-limit-delay 2.0 \
    --output-dir ./reports

# Resultado esperado: 90%+ de taxa de sucesso
# üìä Processamento APRIMORADO de TODOS os 104 portfolios
# ‚úÖ Sucessos: 94
# ‚ùå Falhas: 8  
# üî¥ Circuit Breaker: 2
# üìà Taxa de Sucesso: 90.4%
# üéâ META ATINGIDA: Taxa de sucesso 90.4% >= 90.0%
```

#### 2. Reprocessamento de Falhas
```bash
# Reprocessar apenas portfolios que falharam anteriormente
daycoval batch-enhanced retry-failures \
    --format CSVBR \
    --max-portfolios 10

# Resultado:
# üîÑ REPROCESSAMENTO DE FALHAS:
# ‚úÖ Recuperados: 6
# üéâ Sucesso! 6 portfolios foram recuperados
```

#### 3. Monitoramento e Estat√≠sticas
```bash
# Ver estat√≠sticas detalhadas das falhas
daycoval batch-enhanced failure-stats

# Exportar relat√≥rio de falhas para an√°lise
daycoval batch-enhanced failure-stats \
    --export-csv ./reports/failure_analysis.csv

# Limpar falhas antigas (>24h)
daycoval batch-enhanced failure-stats --clear-old 24
```

### Par√¢metros do Sistema Enhanced

| Par√¢metro | Padr√£o | Descri√ß√£o |
|-----------|--------|-----------|
| `--rate-limit-delay` | `1.0` | Delay entre requests (segundos) |
| `--max-parallel` | `3` | M√°ximo de requests paralelos |
| `--max-portfolios` | Ilimitado | Limitar n√∫mero de portfolios (retry) |

### Sistema de Falhas e Retry

O sistema Enhanced classifica falhas automaticamente e aplica estrat√©gias espec√≠ficas:

| Tipo de Falha | Tentativas | Delay Base | Descri√ß√£o |
|----------------|------------|------------|-----------|
| **API Error (500)** | 5x | 60s | Erros de servidor - aguarda mais |
| **Timeout** | 3x | 30s | Problemas de rede - retry r√°pido |
| **Empty Report** | 2x | 120s | Relat√≥rio vazio - aguarda processamento |
| **Rate Limit (429)** | 10x | 300s | Limite da API - aguarda bastante |
| **Authentication** | 1x | 600s | Erro cr√≠tico - aguarda muito |

### Arquivos de Checkpoint

```bash
# Estrutura autom√°tica criada:
./checkpoints/
‚îú‚îÄ‚îÄ failed_portfolios.json      # Falhas ativas para reprocessamento
‚îú‚îÄ‚îÄ failed_portfolios.json.bak  # Backup autom√°tico
‚îî‚îÄ‚îÄ failure_reports/            # Relat√≥rios detalhados
    ‚îî‚îÄ‚îÄ detailed_report_YYYYMMDD.csv
```

### Quando Usar Enhanced vs Padr√£o

**Use Enhanced quando:**
- üéØ Processamento de todos os 104 portfolios
- üéØ Precisa de alta taxa de sucesso (>90%)
- üéØ Ambiente de produ√ß√£o cr√≠tico
- üéØ Processamento autom√°tico/agendado

**Use Padr√£o quando:**
- üìã Poucos portfolios (<10)  
- üìã Testes e desenvolvimento
- üìã Processamento interativo manual

### üîß Comandos Utilit√°rios

```bash
# Listar todos os fundos dispon√≠veis
python cli.py list portfolios

# Listar classes de investidor dispon√≠veis
python cli.py list investor-classes

# Ver ajuda completa
python cli.py --help

# Ver ajuda de um comando espec√≠fico
python cli.py quoteholder single --help
```

## ‚öôÔ∏è Par√¢metros Avan√ßados

### Op√ß√µes Globais (Aplicam-se a Todos os Comandos)

| Par√¢metro | Padr√£o | Descri√ß√£o |
|-----------|--------|-----------|
| `--format` | `PDF` | Formato: `PDF`, `CSVBR`, `CSVUS`, `TXTBR`, `TXTUS`, `JSON` |
| `--output-dir` | `./reports` | Diret√≥rio onde salvar os arquivos |
| `--config` | `portfolios.json` | Arquivo de configura√ß√£o |
| `--verbose` | Desabilitado | Logs detalhados |

### Par√¢metros Espec√≠ficos - Relat√≥rios de Cotistas

| Par√¢metro | Tipo | Descri√ß√£o | Exemplo |
|-----------|------|-----------|---------|
| `--client-range` | String | Range de clientes | `"1000:5000"` |
| `--advisor-range` | String | Range de assessores | `"1:999"` |
| `--advisor2-range` | String | Range de assessores 2 | `"0:0"` |
| `--investor-class` | Integer | Classe de investidor (-1 a 21) | `-1` (Todos) |
| `--show-if-code` | Boolean | Mostrar c√≥digo IF | `true`/`false` |
| `--excel-headers` | Boolean | Headers formato Excel | `true`/`false` |
| `--message` | String | Mensagem personalizada | `"Relat√≥rio mensal"` |

### Classes de Investidor

| C√≥digo | Descri√ß√£o |
|--------|-----------|
| `-1` | **Todos** (recomendado para uso geral) |
| `0` | PJU - Pessoa Jur√≠dica |
| `1` | PRI - Private |
| `2` | VAR - Varejo |
| `3` | FAC - Fundos em Cotas |
| `4` | PCO - Por Conta e Ordem |
| `5` | INS - Institucional |
| ... | (21 classes no total - use `python cli.py list investor-classes`) |

## üí° Exemplos Pr√°ticos

### Cen√°rio 1: Relat√≥rio Di√°rio de Todos os Fundos
```bash
# Gerar PDFs de carteira di√°ria para todos os 95 fundos
python cli.py daily batch --all-portfolios --date 2025-07-31

# Resultado: 95 arquivos PDF em ./reports/
# Formato: CATALISE_FIC_FIDC_RL_20250731.pdf
```

### Cen√°rio 2: Relat√≥rio de Cotistas com Filtros
```bash
# Apenas investidores pessoa f√≠sica (classe 2) em formato CSV
python cli.py --format CSVBR quoteholder batch --all-portfolios --date 2025-07-31 --investor-class 2

# Resultado: 95 arquivos CSV com apenas cotistas pessoa f√≠sica
# Formato: POSICAO_COTISTAS_CATALISE_FIC_FIDC_RL_20250731.csv
```

### Cen√°rio 3: An√°lise de Fundo Espec√≠fico
```bash
# Relat√≥rio completo de um fundo (carteira + cotistas)
python cli.py daily single --portfolio 4471709 --date 2025-07-31
python cli.py quoteholder single --portfolio 4471709 --date 2025-07-31

# Resultado: 2 arquivos PDF com vis√£o completa do fundo
```

### Cen√°rio 4: Relat√≥rio Regulat√≥rio
```bash
# Cotistas institucionais (classe 5) com headers Excel
python cli.py quoteholder batch --all-portfolios --date 2025-07-31 \
    --investor-class 5 \
    --excel-headers true \
    --message "Relat√≥rio CVM mensal"
```

### Cen√°rio 5: An√°lise de Rentabilidade Sint√©tica
```bash
# Relat√≥rio de performance de todas as carteiras em CSV
daycoval profitability relatorio-rentabilidade-sintetica --format CSVBR

# Resultado: 1 arquivo CSV consolidado com dados de todas as carteiras
# Formato: RENTABILIDADE_SINTETICA_TODAS_CARTEIRAS_YYYYMMDD.csv
```

### Cen√°rio 6: Acompanhamento Peri√≥dico de Performance
```bash
# Rentabilidade sint√©tica com base di√°ria para per√≠odo espec√≠fico
daycoval profitability relatorio-rentabilidade-sintetica \
    --carteiraId 111376 \
    --format PDF \
    --baseDiaria \
    --dataInicial 2025-07-01 \
    --dataFinal 2025-07-31 \
    --tipoRentabilidadeIndice 1

# Resultado: PDF com an√°lise detalhada de performance no per√≠odo
```

## üöÄ Processamento em Lote (Batch)

O sistema suporta processamento em lote para todos os endpoints, com retry inteligente e recupera√ß√£o de falhas.

### ‚ú® Caracter√≠sticas do Processamento Batch

- **Retry Inteligente**: At√© 5 tentativas com backoff exponencial e jitter
- **Circuit Breaker**: Prote√ß√£o contra falhas em cascata da API
- **Rate Limiting**: Controle autom√°tico de taxa para evitar sobrecarga
- **Relat√≥rios de Progresso**: Acompanhe o processamento em tempo real
- **Persist√™ncia de Falhas**: Sistema inteligente de checkpoint para reprocessamento
- **Recupera√ß√£o Autom√°tica**: Comando para reprocessar apenas os que falharam

### üìä Batch - Relat√≥rio de Rentabilidade (Endpoint 1799)

```bash
# Processamento em lote com lista de carteiras inline
daycoval profitability batch-rentabilidade \
    --portfolios "17485,17486,17487" \
    --format CSVBR \
    --data 2024-01-31 \
    --indiceCDI CDI \
    --output-dir ./reports

# Processamento em lote com arquivo de carteiras
daycoval profitability batch-rentabilidade \
    --portfolios-file examples/portfolios_exemplo.txt \
    --format PDF \
    --trataMovimentoAjusteComp \
    --usaNomeLongoTitulo \
    --output-dir ./reports
```

### üè¶ Batch - Extrato Conta Corrente (Endpoint 1988)

```bash
# Processamento em lote para extratos
daycoval profitability batch-extrato-conta-corrente \
    --portfolios "17485,17486,17487" \
    --format CSVBR \
    --dataInicial 2024-01-01 \
    --dataFinal 2024-01-31 \
    --agencia "00019" \
    --conta "0000000123" \
    --output-dir ./reports

# Com arquivo de portfolios e configura√ß√µes avan√ßadas
daycoval profitability batch-extrato-conta-corrente \
    --portfolios-file examples/portfolios_exemplo.txt \
    --format PDF \
    --dataInicial 2024-01-01 \
    --agencia "00019" \
    --conta "0000000123" \
    --dias 30 \
    --nomeRelatorioEsquerda \
    --output-dir ./reports
```

### üìù Formato do Arquivo de Portfolios

Crie um arquivo de texto simples com um ID de portfolio por linha:

```text
# examples/portfolios_exemplo.txt
17485
17486
17487
17488
17489
```

### üìà Monitoramento do Processamento

Durante a execu√ß√£o, voc√™ ver√°:

```bash
üöÄ Processamento em lote - Relat√≥rio de Rentabilidade (1799)
   Portfolios: 5
   Formato: CSVBR

üîÑ Processando 1/5: 17485 (FUNDO_EXEMPLO_01)
      ‚úÖ Processado: 2.45 MB
      üìÅ Salvo: RENTABILIDADE_FUNDO_EXEMPLO_01_2024-01-31.csv

üîÑ Processando 2/5: 17486 (FUNDO_EXEMPLO_02)
      ‚ùå Falha final ap√≥s retries: API timeout

üìä RESUMO DO PROCESSAMENTO:
   ‚úÖ Sucessos: 4
   ‚ùå Falhas: 1
   üìà Taxa de Sucesso: 80.0%

‚úÖ Processamento conclu√≠do!
   Sucessos: 4/5
   Taxa de sucesso: 80.0%
```

### üîÑ Reprocessamento de Falhas

O sistema automaticamente salva informa√ß√µes sobre portfolios que falharam. Use o processador enhanced para reprocessar apenas os que tiveram problema:

```python
# Exemplo program√°tico para reprocessar falhas
from daycoval.services.enhanced_batch_processor import create_enhanced_batch_processor

processor = create_enhanced_batch_processor()
# O m√©todo process_failed_portfolios_retry() reprocessa automaticamente
# apenas os portfolios que falharam anteriormente
```

## üõ†Ô∏è Solu√ß√£o de Problemas

### Erro: "No module named 'utils'"
```bash
# Problema: Caminho do m√≥dulo utils
# Solu√ß√£o: Verificar se utils/ est√° no diret√≥rio correto
# Ou executar de: C:\Users\atrindade\catalise\DataAnalytics\
```

### Erro: "Invalid URL 'None/report/reports/32'"
```bash
# Problema: BASE_URL n√£o definida no api.py
# Solu√ß√£o: Verificar se BASE_URL = "https://apigw.daycoval.com.br/custodia"
```

### Erro: "unrecognized arguments: --format"
```bash
# Problema: Ordem incorreta dos argumentos
# ‚ùå Errado: python cli.py quoteholder --format PDF batch
# ‚úÖ Correto: python cli.py --format PDF quoteholder batch
```

### Rate Limiting (429 Too Many Requests)
```bash
# O sistema tem rate limiting autom√°tico
# Se persistir, ajustar em portfolios.json:
# "rate_limit": { "max_calls": 20, "period_seconds": 60 }
```

### Arquivos N√£o Gerados
```bash
# Verificar permiss√µes do diret√≥rio
# Usar --verbose para logs detalhados
python cli.py --verbose daily single --portfolio 4471709 --date 2025-07-31
```

## üìÅ Estrutura dos Arquivos Gerados

### Nomenclatura Autom√°tica

**Relat√≥rios Di√°rios:**
```
NOME_DO_FUNDO_YYYYMMDD.extensao
Exemplo: CATALISE_FIC_FIDC_RL_20250731.pdf
```

**Relat√≥rios de Cotistas:**
```
POSICAO_COTISTAS_NOME_DO_FUNDO_YYYYMMDD.extensao
Exemplo: POSICAO_COTISTAS_CATALISE_FIC_FIDC_RL_20250731.pdf
```

### Organiza√ß√£o Sugerida
```
reports/
‚îú‚îÄ‚îÄ daily/                   # Relat√≥rios de carteira di√°ria
‚îÇ   ‚îú‚îÄ‚îÄ 2025-07-31/
‚îÇ   ‚îî‚îÄ‚îÄ 2025-08-01/
‚îú‚îÄ‚îÄ quoteholders/            # Relat√≥rios de cotistas
‚îÇ   ‚îú‚îÄ‚îÄ 2025-07-31/
‚îÇ   ‚îî‚îÄ‚îÄ 2025-08-01/
‚îî‚îÄ‚îÄ logs/                    # Logs do sistema
```

---

## üî• NOVA ESTRUTURA CLI v2.5 - Rentabilidade Sint√©tica (Endpoint 1048)

### ‚ö° Comandos Refatorados (IMPLEMENTA√á√ÉO FINAL)

A estrutura CLI foi **completamente refatorada** baseada na an√°lise do Gemini CLI 2.5 Pro para resolver os problemas de parsing e funcionalidade.

#### üéØ Comando: `synthetic-profitability single`

**Portfolio espec√≠fico com base di√°ria:**
```bash
# Comando CORRETO para o caso de uso original reportado
daycoval profitability synthetic-profitability single 12345 \
    --daily-base \
    --start-date 2025-08-01 \
    --end-date 2025-08-29 \
    --format PDF \
    --profitability-type 0

# Portfolio espec√≠fico sem base di√°ria
daycoval profitability synthetic-profitability single 12345 \
    --format CSVBR \
    --profitability-type 1
```

#### üéØ Comando: `synthetic-profitability all`

**Todos os portfolios (individual + consolidado):**
```bash
# Todos com base di√°ria - CSV (gera individual + consolidado)
daycoval profitability synthetic-profitability all \
    --daily-base \
    --start-date 2025-08-01 \
    --end-date 2025-08-29 \
    --format CSVBR \
    --profitability-type 0

# Todos em PDF (apenas individuais)
daycoval profitability synthetic-profitability all \
    --format PDF \
    --profitability-type 2
```

### üìä Funcionalidades Implementadas

| Funcionalidade | Status | Descri√ß√£o |
|----------------|--------|-----------|
| ‚úÖ **CLI Parsing** | **CORRIGIDO** | `daily-base` n√£o √© mais interpretado como portfolio ID |
| ‚úÖ **Sa√≠da Dupla** | **IMPLEMENTADO** | CSV: arquivos individuais + consolidado |
| ‚úÖ **Date Range** | **CORRIGIDO** | `--start-date` e `--end-date` funcionam com `--daily-base` |
| ‚úÖ **Logging** | **APRIMORADO** | Rastreamento detalhado dos par√¢metros de API |
| ‚úÖ **Defensive Programming** | **APLICADO** | Prote√ß√£o contra AttributeError em portfolios opcionais |

### üîç Exemplo de Output

**Comando:**
```bash
daycoval profitability synthetic-profitability all --format CSVBR --daily-base --start-date 2025-08-01 --end-date 2025-08-29
```

**Resultado esperado:**
```
üìä Processando TODOS os 95 portfolios:
   - Arquivos individuais por fundo
   - Arquivo consolidado final

üîÑ Gerando relat√≥rios individuais...
   [1/95] 12345 (FUNDO ALPHA FIDC)
      ‚úÖ Salvo: FUNDO_ALPHA_FIDC_SINTETICA_20250829.csv
   [2/95] 12346 (FUNDO BETA FIDC)
      ‚úÖ Salvo: FUNDO_BETA_FIDC_SINTETICA_20250829.csv
   ...

üîÑ Gerando arquivo consolidado...
      ‚úÖ Consolidado: CONSOLIDADO_SINTETICA_TODOS_FUNDOS_20250829.csv

üéØ RESULTADO FINAL:
   Total portfolios: 95
   ‚úÖ Sucessos: 93
   ‚ùå Falhas: 2
   üìà Taxa de sucesso: 97.9%
   üìÅ Diret√≥rio: ./reports
```

---

## üöÄ Scripts de Automa√ß√£o

### Script Di√°rio (Bash/PowerShell)
```bash
#!/bin/bash
# Gerar relat√≥rios di√°rios automaticamente
DATE=$(date +%Y-%m-%d)

echo "Gerando relat√≥rios para $DATE..."

# Relat√≥rios de carteira
python cli.py daily batch --all-portfolios --date "$DATE" --output-dir "./reports/daily/$DATE"

# Relat√≥rios de cotistas
python cli.py quoteholder batch --all-portfolios --date "$DATE" --output-dir "./reports/quoteholders/$DATE"

echo "Conclu√≠do!"
```

### Agendamento (Windows Task Scheduler)
```
Programa: python
Argumentos: cli.py daily batch --all-portfolios --date 2025-07-31
Diret√≥rio: C:\caminho\para\daycoval\
Hor√°rio: 08:00 (ap√≥s fechamento do D-1)
```

## üîß Changelog v2.1 (02/09/2025)

### Corre√ß√µes Cr√≠ticas Implementadas

**PROBLEMA RESOLVIDO:** Comando `synthetic` com erro de parsing
- ‚ùå **ANTES**: `daycoval profitability synthetic daily-base --start-date...` ‚Üí Erro: "Portfolio daily-base n√£o encontrado"
- ‚úÖ **AGORA**: `daycoval profitability synthetic --daily-base --start-date...` ‚Üí Funciona corretamente

**PROBLEMA RESOLVIDO:** --all-portfolios gerando apenas consolidado
- ‚ùå **ANTES**: `--all-portfolios` gerava apenas 1 arquivo consolidado
- ‚úÖ **AGORA**: `--all-portfolios` gera 104 arquivos individuais + 1 consolidado = 105 arquivos total

**PROBLEMA RESOLVIDO:** Par√¢metros de data ignorados
- ‚ùå **ANTES**: `--start-date` e `--end-date` eram ignorados sem `--daily-base`
- ‚úÖ **AGORA**: Par√¢metros de data funcionam corretamente com `--daily-base`

### Comandos Corretos v2.1
```bash
# ‚úÖ COMANDO CORRIGIDO (usar este)
daycoval profitability synthetic --portfolio-id 1001 --daily-base --start-date 2025-08-01 --end-date 2025-08-29 --format PDF

# ‚úÖ TODOS OS PORTFOLIOS (105 arquivos gerados)
daycoval profitability synthetic --all-portfolios --format CSVBR --daily-base --start-date 2025-08-01 --end-date 2025-08-29
```

## üìû Suporte

Para d√∫vidas ou problemas:

1. **Verificar logs**: Usar `--verbose` para informa√ß√µes detalhadas
2. **Consultar este README**: Exemplos e solu√ß√µes comuns
3. **Testar conectividade**: `python cli.py list portfolios`
4. **Validar configura√ß√£o**: `python setup.py`
5. **Testar comando synthetic**: `daycoval profitability synthetic --help`

---

**Vers√£o:** 2.1  
**√öltima atualiza√ß√£o:** 02/09/2025  
**Endpoints suportados:** 32 (Carteira Di√°ria), 45 (Posi√ß√£o de Cotistas), 1048 (Rentabilidade Sint√©tica)  
**Fundos configurados:** 95